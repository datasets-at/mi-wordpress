#!/usr/bin/bash
#
# Put customizations to your image in this file.

PATH=/opt/local/gnu/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

# Exit if any commands fail
set -o errexit

# Ensure we have updated standard packages
echo "* Updating standard packages.";
pkg_delete -v nodejs smtools zoneinit
pkg_add -v nodejs smtools zoneinit

# Configuring nginx packages
echo "* Configuring nginx.";

mkdir -p /opt/local/www/wordpress
mkdir -p /opt/local/etc/nginx/sites-enabled
mkdir -p /opt/local/etc/nginx/sites-available
mkdir -p /opt/local/etc/nginx/globals
mkdir -p /var/db/ssl

svcadm enable nginx
svcadm enable php-fpm
svcadm restart nginx
svcadm restart php-fpm

# Configuring wp-cli packages
echo "* Configuring wp-cli.";

cd /root
curl -L https://raw.github.com/wp-cli/builds/gh-pages/phar/wp-cli.phar > wp-cli.phar
chmod +x wp-cli.phar
mv wp-cli.phar /opt/local/bin/wp

mkdir -p /opt/local/etc/nginx/sites-enabled
mkdir -p /opt/local/etc/nginx/sites-available

cp /root/nginx.conf /opt/local/etc/nginx/nginx.conf
cp /root/php.ini /opt/local/etc/php.ini

chown -R www:www /opt/local/www
chown root:root /opt/local/etc/nginx/sites-enabled
chown root:root /opt/local/etc/nginx/sites-available
chmod -R a+r /opt/local/etc/nginx/sites-enabled
chmod -R a+r /opt/local/etc/nginx/sites-available
chown root:root /var/db/ssl
find /var/db/ssl -type d | xargs chmod 700
find /var/db/ssl -type f | xargs chmod 600

# ln -s /opt/local/etc/nginx/sites-available/wordpress-ssl.conf /opt/local/etc/nginx/sites-enabled/
ln -s /opt/local/etc/nginx/sites-available/wordpress.conf /opt/local/etc/nginx/sites-enabled/

svcadm restart nginx && svcadm restart php-fpm
svcadm enable postfix
newaliases

# Clean up
echo "* Cleaning up."
pkg_delete -v gcc47 gmake
rm -rf /root/*

# Prepare image for provisioning
sm-prepare-image -y
